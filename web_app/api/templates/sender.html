<!DOCTYPE html>

<html lang="en">

<head>
    <link rel="stylesheet" href="../static/styles/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Announcement detector MVP</title>
    <meta name="description" content="Announcement detection MVP">
    <meta name="author" content="Maximilian Noelle-Wying">
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
        integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
        crossorigin="anonymous"></script>
    <script src="https://www.WebRTC-Experiment.com/RecordRTC.js"></script>
    <script type="text/javascript" charset="utf-8">
        var socket = io();
        socket.on('connect', function () {
            console.log("connecting to web socket..");
            socket.emit('connection', socket.id);
        });
        /*window.onbeforeunload = function (event) {
            event.preventDefault();
            socket.emit('disconnection_test', socket.id);
        }*/
        window.addEventListener("beforeunload", function (event) {
            socket.emit('disconnection', socket.id);
            socket.disconnect()
            console.log("disconnection from web socket..");
        });
        socket.on('prediction_result', function (msg) {
            console.log('Received message: '+msg);
        });

        
        async function record(){
            let stream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
            let dt = new Date().getTime();
            recordAudio = await RecordRTC(stream, {
                type: 'audio',
                mimeType: 'audio/wav',
                //bufferSize: 256,
                //sampleRate: 48000,
                //bitsPerSecond: 128000,
                //audioBitsPerSecond: 128000,
                recorderType: StereoAudioRecorder,
                numberOfAudioChannels: 1,
                timeSlice: 100,
                desiredSampRate: 16000,
                ondataavailable: async (blob)  =>{ 
                    socket.emit("predict_sequence", socket.id, blob, dt)
                 },
                //ondataavailable: (blob) => { console.log(blob) },
            });

            await recordAudio.startRecording();
        }

        async function stop(){
            socket.emit("stop",socket.id)
            await recordAudio.stopRecording()
        }
    </script>
    <h1>Announcement detection</h1>
    <div id="main_window">
        <h2>Mic prediction</h2>
        <button onclick="record()">Record</button>
        <button onclick="stop()">Stop</button>
        <br><br>
        <h2>File prediction (w/o transcription)</h2>
        <form action="/file_prediction" method="post" enctype="multipart/form-data">
            <input type="file" name="file" />
            <input type="submit" value="Upload">
        </form>
    </div>
</body>
</html>